<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>البوابة المعرفية التابعة لـ SA</title>
    <!-- Library for QR Code Generation -->
    <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
        :root {
            --bg-color: #020010;
            --primary-color: #00f2ea;
            --secondary-color: #d400ff;
            --glass-bg: rgba(15, 10, 35, 0.45);
            --border-color: rgba(0, 242, 234, 0.25);
            --text-color: #f0f0f0;
            --text-secondary: #b0b0c0;
            --glow-color: rgba(0, 242, 234, 0.7);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-color); min-height: 100vh; overflow-x: hidden; }

        .background-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; overflow: hidden; }
        .stars { background: black url(https://s3-us-west-2.amazonaws.com/s.cdpn.io/1231630/stars.png) repeat; position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; z-index: 0; animation: move-stars-anim 40s linear infinite; }
        #cursor-glow { position: fixed; width: 800px; height: 800px; background: radial-gradient(circle, var(--glow-color) 0%, transparent 50%); border-radius: 50%; pointer-events: none; transform: translate(-50%, -50%); transition: transform 0.1s ease-out; opacity: 0.1; z-index: -1; }

        .container { width: 90%; max-width: 950px; margin: 0 auto; padding: 2rem 1rem; z-index: 1; }
        header { text-align: center; margin-bottom: 2rem; position: relative; }
        header h1 { font-size: 3rem; background: -webkit-linear-gradient(45deg, var(--primary-color), #fff, var(--secondary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: fadeInDown-anim 1s ease-out; }
        header p { font-size: 1.1rem; color: var(--text-secondary); margin-top: 0.5rem; animation: fadeInUp-anim 1.2s ease-out; }

        .trending-topics-container { text-align: center; margin-bottom: 1rem; }
        .trending-topics { display: flex; justify-content: center; gap: 0.8rem; flex-wrap: wrap; }
        .trending-item { background: var(--glass-bg); border: 1px solid var(--border-color); color: var(--text-secondary); padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; transition: all 0.3s ease; font-size: 0.9rem; }
        .trending-item:hover { color: var(--primary-color); border-color: var(--primary-color); transform: translateY(-3px); }

        .search-bar { width: 100%; display: flex; align-items: center; background: var(--glass-bg); backdrop-filter: blur(12px); border: 1px solid var(--border-color); border-radius: 50px; box-shadow: 0 5px 25px rgba(0,0,0,0.5), 0 0 15px rgba(0,242,234,0.2) inset; transition: all 0.3s ease; }
        .search-bar:focus-within, .search-bar.listening { box-shadow: 0 5px 30px rgba(0,0,0,0.7), 0 0 25px var(--glow-color) inset; border-color: var(--primary-color); }
        #searchInput { background: transparent; border: none; outline: none; color: var(--text-color); font-size: 1.1rem; width: 100%; padding: 1rem 1.5rem; }
        #langSelect { background-color: #020010; color: #fff; border: none; outline: none; font-size: 1.1rem; padding: 0 1rem; cursor: pointer; font-weight: bold; }
        html[dir="rtl"] #langSelect { border-left: 1px solid var(--primary-color); border-radius: 0 50px 50px 0; }
        html[dir="ltr"] #langSelect { border-right: 1px solid var(--primary-color); border-radius: 50px 0 0 50px; }
        .icon-button { background: transparent; border: none; padding: 0 1.2rem; cursor: pointer; color: var(--text-secondary); transition: color 0.3s ease; display: flex; align-items: center; justify-content: center; }
        .icon-button:hover { color: var(--primary-color); }
        #voiceSearchBtn.listening svg { animation: pulse-anim 1.5s infinite; }
        #searchButton { background: var(--primary-color); border: none; border-radius: 50px; margin: 5px; padding: 0.8rem 1rem; cursor: pointer; color: #050210; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; }
        #searchButton:hover { background: #fff; box-shadow: 0 0 20px var(--glow-color); }
        
        #main-content-wrapper { transition: opacity 0.5s ease; }
        #popular-articles-section { margin-top: 3rem; text-align: center; }
        #popular-articles-section h3 { font-size: 1.5rem; color: var(--text-color); margin-bottom: 1.5rem; }
        #popular-articles-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1rem; text-align: right; }
        .popular-card { background-size: cover; background-position: center; border-radius: 12px; border: 1px solid var(--border-color); position: relative; aspect-ratio: 16 / 10; cursor: pointer; overflow: hidden; display: flex; align-items: flex-end; padding: 1rem; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .popular-card::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to top, rgba(0,0,0,0.9) 20%, rgba(0,0,0,0) 60%); }
        .popular-card:hover { transform: translateY(-5px); box-shadow: 0 0 25px var(--glow-color); }
        .popular-card h4 { z-index: 2; color: #fff; font-size: 1.1rem; }

        #results-list { margin-top: 3rem; display: grid; gap: 2rem; }
        .card-3d-container { perspective: 1000px; animation: slideUp-anim 0.7s ease-out forwards; opacity: 0; transform: translateY(40px); }
        .result-card { background: var(--glass-bg); backdrop-filter: blur(15px); border: 1px solid var(--border-color); border-radius: 20px; padding: 1.5rem; box-shadow: 0 10px 30px rgba(0,0,0,0.4); transition: transform 0.2s ease-out; transform-style: preserve-3d; position: relative; overflow: hidden; }
        .result-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at var(--mx, 50%) var(--my, 50%), rgba(255,255,255,0.15), transparent 40%); opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .card-3d-container:hover .result-card::before { opacity: 1; }
        .card-content { transform: translateZ(20px); }
        .card-header { display: flex; gap: 1.5rem; align-items: center; }
        .card-header img { width: 100px; height: 100px; object-fit: cover; border-radius: 15px; border: 1px solid var(--border-color); flex-shrink: 0; }
        .card-header h2 { font-size: 1.6rem; color: #fff; }
        .card-body p { line-height: 1.7; color: var(--text-secondary); margin: 1rem 0; }
        .card-actions { display: flex; gap: 0.8rem; flex-wrap: wrap; }
        .card-actions button { background: rgba(0,0,0,0.2); border: 1px solid var(--border-color); color: var(--text-secondary); padding: 0.6rem 1.2rem; border-radius: 30px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem; }
        .card-actions button:hover { color: var(--primary-color); border-color: var(--primary-color); background: rgba(0,242,234,0.1); }
        .card-actions button svg { width: 16px; height: 16px; flex-shrink: 0; }

        /* --- Fullscreen Views & Modals --- */
        .fullscreen-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(2, 0, 16, 0.95); backdrop-filter: blur(10px); z-index: 200; display: none; flex-direction: column; animation: fadeIn-anim 0.4s ease; }
        .view-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; color: var(--text-color); flex-shrink: 0; border-bottom: 1px solid var(--border-color); }
        .view-header h2 { font-size: 1.5rem; }
        .view-close-btn { background: transparent; border: none; font-size: 2.5rem; color: var(--text-color); cursor: pointer; transition: transform 0.3s ease; }
        .view-close-btn:hover { color: var(--primary-color); transform: rotate(90deg); }
        .gallery-grid-container { flex-grow: 1; overflow-y: auto; padding: 1.5rem; }
        .gallery-image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
        .gallery-item { cursor: pointer; border: 1px solid var(--border-color); aspect-ratio: 1 / 1; }
        .gallery-item img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease; }
        .gallery-item:hover img { transform: scale(1.1); }

        /* --- Share Modal --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(2, 0, 16, 0.8); backdrop-filter: blur(8px); z-index: 300; display: none; align-items: center; justify-content: center; animation: fadeIn-anim 0.4s ease; }
        .share-modal { background: var(--glass-bg); border: 1px solid var(--border-color); border-radius: 20px; padding: 2rem; width: 90%; max-width: 450px; text-align: center; box-shadow: 0 0 40px var(--glow-color); }
        .share-modal h3 { font-size: 1.5rem; margin-bottom: 1.5rem; color: #fff; }
        #qrcode { display: flex; justify-content: center; align-items: center; padding: 10px; background: #fff; border-radius: 10px; margin-bottom: 1.5rem; }
        .link-container { display: flex; margin-bottom: 1.5rem; }
        .link-container input { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); color: var(--text-color); padding: 0.7rem; border-radius: 5px 0 0 5px; }
        .link-container button { background: var(--primary-color); color: #020010; border: none; padding: 0.7rem 1rem; cursor: pointer; border-radius: 0 5px 5px 0; font-weight: bold; }
        .social-share a { color: var(--text-secondary); margin: 0 0.7rem; text-decoration: none; font-size: 2rem; transition: color 0.3s ease, transform 0.3s ease; display: inline-block; }
        .social-share a:hover { color: var(--primary-color); transform: scale(1.2); }

        .loader { text-align: center; padding: 2rem; display: none; }
        .loader-inner { width: 50px; height: 50px; border: 4px solid var(--border-color); border-top: 4px solid var(--primary-color); border-radius: 50%; animation: spin-anim 1s linear infinite; margin: 0 auto; }

        @keyframes fadeIn-anim { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInDown-anim { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInUp-anim { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp-anim { to { opacity: 1; transform: translateY(0); } }
        @keyframes spin-anim { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes move-stars-anim { from { background-position: 0 0; } to { background-position: 0 -10000px; } }
        @keyframes pulse-anim { 0% { color: var(--primary-color); transform: scale(1); } 50% { color: #fff; transform: scale(1.2); } 100% { color: var(--primary-color); transform: scale(1); } }
    </style>
</head>
<body>

    <div class="background-container"><div class="stars"></div></div>
    <div id="cursor-glow"></div>

    <div class="container">
        <header>
            <h1 data-key="main-title">البوابة المعرفية التابعة لـ SA</h1>
            <p data-key="subtitle">استكشف، تفاعل، وشارك المعرفة بطريقة لم تعهدها من قبل</p>
        </header>

        <main>
            <div class="trending-topics-container">
                <div class="trending-topics" id="trending-topics"></div>
            </div>
            <div class="search-wrapper">
                <div class="search-bar" id="search-bar">
                    <select id="langSelect">
                        <option value="ar">العربية</option><option value="en">English</option><option value="es">Español</option><option value="fr">Français</option><option value="de">Deutsch</option><option value="ru">Русский</option><option value="zh">中文</option><option value="ja">日本語</option>
                    </select>
                    <input type="text" id="searchInput" data-key-placeholder="search-placeholder">
                    <button id="voiceSearchBtn" class="icon-button" title="Voice Search">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                    </button>
                    <button id="searchButton"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></button>
                </div>
            </div>
            
            <div id="main-content-wrapper">
                <div id="popular-articles-section">
                    <h3 data-key="popular-title">استكشف مقالات رائجة</h3>
                    <div id="popular-loader" class="loader"><div class="loader-inner"></div></div>
                    <div id="popular-articles-grid"></div>
                </div>
            </div>

            <div id="main-loader" class="loader"><div class="loader-inner"></div></div>
            <div id="results-list"></div>
        </main>
    </div>

    <!-- Fullscreen Gallery -->
    <div id="fullscreen-gallery" class="fullscreen-view">
        <div class="view-header"><h2 id="gallery-title"></h2><button id="gallery-close-btn" class="view-close-btn">&times;</button></div>
        <div class="gallery-grid-container">
             <div class="loader"><div class="loader-inner"></div></div>
             <div class="gallery-image-grid"></div>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="share-modal-overlay" class="modal-overlay">
        <div class="share-modal">
            <button id="modal-close-btn" class="view-close-btn" style="position: absolute; top: 10px; right: 15px;">&times;</button>
            <h3 data-key="share-title">مشاركة النتيجة</h3>
            <div id="qrcode"></div>
            <div class="link-container">
                <input type="text" id="share-link-input" readonly>
                <button id="copy-link-btn" data-key="copy-link">نسخ</button>
            </div>
            <div class="social-share">
                <a id="share-whatsapp" href="#" target="_blank" title="WhatsApp"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M12.04 2C6.58 2 2.13 6.45 2.13 11.91C2.13 13.66 2.59 15.36 3.45 16.86L2.05 22L7.3 20.62C8.75 21.41 10.37 21.82 12.04 21.82C17.5 21.82 21.95 17.37 21.95 11.91C21.95 6.45 17.5 2 12.04 2M9.23 7.52C9.03 7.52 8.84 7.52 8.67 7.52C8.37 7.52 8.1 7.61 7.89 8.04C7.68 8.47 7.03 9.12 7.03 10.23C7.03 11.33 7.91 12.39 8.06 12.57C8.21 12.75 9.76 15.11 12.18 16.09C14.21 16.92 14.65 16.74 15.02 16.7C15.44 16.64 16.43 16.07 16.63 15.44C16.83 14.81 16.83 14.27 16.75 14.17C16.67 14.07 16.51 14.02 16.23 13.88C15.95 13.74 14.58 13.08 14.34 12.97C14.1 12.86 13.93 12.81 13.78 13.05C13.63 13.29 13.12 13.88 12.95 14.07C12.78 14.26 12.61 14.29 12.33 14.15C11.23 13.73 10.26 12.89 9.51 12.24C9.01 11.41 8.87 11.17 8.73 10.93C8.86 10.8 9 10.66C9.13 10.53 9.42 10.17 9.57 10C9.73 9.7 9.83 9.52 9.71 9.25C9.64 9.13 9.23 8 9.03 7.52Z"/></svg></a>
                <a id="share-twitter" href="#" target="_blank" title="Twitter (X)"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>
                <a id="share-facebook" href="#" target="_blank" title="Facebook"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 2.04C6.5 2.04 2 6.53 2 12.06C2 17.06 5.66 21.21 10.44 21.96V14.96H7.9V12.06H10.44V9.85C10.44 7.32 11.93 5.96 14.22 5.96C15.31 5.96 16.45 6.15 16.45 6.15V8.62H15.19C13.95 8.62 13.56 9.39 13.56 10.18V12.06H16.34L15.89 14.96H13.56V21.96A10 10 0 0 0 12 2.04Z"/></svg></a>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const uiStrings = {
            ar: { 
                "main-title": "البوابة المعرفية التابعة لـ SA", "subtitle": "استكشف، تفاعل، وشارك المعرفة بطريقة لم تعهدها من قبل", 
                "search-placeholder": "ابحث هنا أو اضغط على المايكروفون...", "popular-title": "استكشف مقالات رائجة",
                "btn-gallery": "صور", "btn-share": "مشاركة نتيجتي", "btn-save": "حفظ",
                "gallery-title-prefix": "معرض صور:", "gallery-error": "لم يتم العثور على صور.",
                "share-title": "مشاركة النتيجة", "copy-link": "نسخ", "copied-link": "تم النسخ!",
                "popular-error": "تعذر تحميل المقالات الرائجة.", "trending-error": "تعذر تحميل الاقتراحات."
            },
            en: { 
                "main-title": "SA Knowledge Portal", "subtitle": "Explore, interact, and share knowledge like never before", 
                "search-placeholder": "Search here or press the microphone...", "popular-title": "Explore Popular Articles",
                "btn-gallery": "Images", "btn-share": "Share Result", "btn-save": "Save",
                "gallery-title-prefix": "Image Gallery:", "gallery-error": "No images found.",
                "share-title": "Share Result", "copy-link": "Copy", "copied-link": "Copied!",
                "popular-error": "Could not load popular articles.", "trending-error": "Could not load suggestions."
            }
        };

        // --- Element selectors ---
        const searchInput = document.getElementById('searchInput');
        const langSelect = document.getElementById('langSelect');
        const resultsList = document.getElementById('results-list');
        const mainLoader = document.getElementById('main-loader');
        const popularLoader = document.getElementById('popular-loader');
        const popularGrid = document.getElementById('popular-articles-grid');
        const trendingTopicsContainer = document.getElementById('trending-topics');
        const mainContentWrapper = document.getElementById('main-content-wrapper');
        const cursorGlow = document.getElementById('cursor-glow');
        const fullscreenGallery = document.getElementById('fullscreen-gallery');
        const shareModalOverlay = document.getElementById('share-modal-overlay');
        const qrcodeContainer = document.getElementById('qrcode');
        let qrCode = null;

        // --- Core Functions ---
        const setLanguage = (lang) => {
            const strings = uiStrings[lang] || uiStrings.en;
            const isRTL = lang === 'ar';
            document.documentElement.lang = lang;
            document.documentElement.dir = isRTL ? 'rtl' : 'ltr';
            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                if (strings[key]) el.textContent = strings[key];
            });
            document.querySelectorAll('[data-key-placeholder]').forEach(el => {
                 const key = el.getAttribute('data-key-placeholder');
                 if (strings[key]) el.placeholder = strings[key];
            });
            localStorage.setItem('preferredLang', lang);
            langSelect.value = lang;
            fetchTrendingTopics(lang);
            fetchPopularArticles(lang);
        };

        const getApiDate = () => {
            const date = new Date(); date.setDate(date.getDate() - 1);
            const year = date.getFullYear(), month = ('0' + (date.getMonth() + 1)).slice(-2), day = ('0' + date.getDate()).slice(-2);
            return { year, month, day };
        }

        const fetchTrendingTopics = async (lang) => {
            trendingTopicsContainer.innerHTML = '';
            const strings = uiStrings[lang] || uiStrings.en;
            try {
                const { year, month, day } = getApiDate();
                const response = await fetch(`https://wikimedia.org/api/rest_v1/metrics/pageviews/top/${lang}.wikipedia.org/all-access/${year}/${month}/${day}`);
                const data = await response.json();
                const articles = data.items[0].articles.filter(a => !a.article.includes(':')).slice(0, 4);
                articles.forEach(article => {
                    const item = document.createElement('button');
                    item.className = 'trending-item';
                    item.textContent = article.article.replace(/_/g, ' ');
                    item.onclick = () => { searchInput.value = item.textContent; performSearch(); };
                    trendingTopicsContainer.appendChild(item);
                });
            } catch (error) { trendingTopicsContainer.innerHTML = `<p style="font-size:0.9rem;">${strings['trending-error']}</p>`; }
        };

        const fetchPopularArticles = async (lang) => {
            popularGrid.innerHTML = '';
            popularLoader.style.display = 'block';
            const strings = uiStrings[lang] || uiStrings.en;
            try {
                const { year, month, day } = getApiDate();
                const response = await fetch(`https://wikimedia.org/api/rest_v1/metrics/pageviews/top/${lang}.wikipedia.org/all-access/${year}/${month}/${day}`);
                const data = await response.json();
                const articles = data.items[0].articles.filter(a => !a.article.includes(':')).slice(0, 10);
                const titles = articles.map(a => a.article).join('|');
                const imgResponse = await fetch(`https://${lang}.wikipedia.org/w/api.php?action=query&origin=*&format=json&titles=${encodeURIComponent(titles)}&prop=pageimages&pithumbsize=500`);
                const imgData = await imgResponse.json();
                const pages = imgData.query.pages;
                popularGrid.innerHTML = '';
                articles.forEach(article => {
                    const pageData = Object.values(pages).find(p => p.title.replace(/ /g, '_') === article.article);
                    const imageUrl = pageData?.thumbnail?.source || `https://via.placeholder.com/500x300.png?text=${article.article.replace(/_/g, ' ')}`;
                    const card = document.createElement('div');
                    card.className = 'popular-card';
                    card.style.backgroundImage = `url(${imageUrl})`;
                    card.dataset.title = article.article.replace(/_/g, ' ');
                    card.innerHTML = `<h4>${article.article.replace(/_/g, ' ')}</h4>`;
                    card.onclick = () => { searchInput.value = card.dataset.title; performSearch(); };
                    popularGrid.appendChild(card);
                });
            } catch (error) { popularGrid.innerHTML = `<p>${strings['popular-error']}</p>`; } 
            finally { popularLoader.style.display = 'none'; }
        };

        const performSearch = async () => {
            const query = searchInput.value.trim();
            resultsList.innerHTML = '';
            if (!query) {
                mainContentWrapper.style.display = 'block';
                return;
            }
            mainContentWrapper.style.display = 'none';
            mainLoader.style.display = 'block';
            const lang = langSelect.value;
            try {
                const url = `https://${lang}.wikipedia.org/w/api.php?action=query&origin=*&format=json&generator=search&gsrnamespace=0&gsrlimit=10&gsrsearch=${encodeURIComponent(query)}&prop=extracts|pageimages&exintro=1&explaintext=1&piprop=thumbnail&pithumbsize=300`;
                const response = await fetch(url);
                const data = await response.json();
                resultsList.innerHTML = '';
                if (!data.query || !data.query.pages) throw new Error("No results");
                Object.values(data.query.pages).sort((a, b) => a.index - b.index).forEach((page, i) => createResultCard(page, i));
                init3dCardEffect();
            } catch (error) { resultsList.innerHTML = `<p style="text-align:center;">No results found.</p>`; } 
            finally { mainLoader.style.display = 'none'; }
        };

        const createResultCard = (page, index) => {
            const container = document.createElement('div');
            container.className = 'card-3d-container';
            container.style.animationDelay = `${index * 0.1}s`;
            const imageUrl = page.thumbnail ? page.thumbnail.source : `https://via.placeholder.com/100x100.png?text=...`;
            const lang = langSelect.value;
            const strings = uiStrings[lang] || uiStrings.en;

            container.innerHTML = `
                <div class="result-card" data-pageid="${page.pageid}" data-title="${page.title}">
                    <div class="card-content">
                        <div class="card-header"><img src="${imageUrl}" alt="${page.title}"><h2>${page.title}</h2></div>
                        <div class="card-body"><p>${page.extract ? page.extract.substring(0, 180) + '...' : ''}</p></div>
                        <div class="card-actions">
                            <button class="btn-gallery"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg><span>${strings['btn-gallery']}</span></button>
                            <button class="btn-share"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg><span>${strings['btn-share']}</span></button>
                            <button class="btn-save"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg><span>${strings['btn-save']}</span></button>
                        </div>
                    </div>
                </div>`;
            resultsList.appendChild(container);
        };

        const showGallery = async (title, lang) => {
            const strings = uiStrings[lang] || uiStrings.en;
            fullscreenGallery.style.display = 'flex';
            const grid = fullscreenGallery.querySelector('.gallery-image-grid');
            const loader = fullscreenGallery.querySelector('.loader');
            fullscreenGallery.querySelector('#gallery-title').textContent = `${strings['gallery-title-prefix']} ${title}`;
            grid.innerHTML = ''; loader.style.display = 'block';
            try {
                const url = `https://${lang}.wikipedia.org/w/api.php?action=query&origin=*&format=json&titles=${encodeURIComponent(title)}&generator=images&gimlimit=100&prop=imageinfo&iiprop=url`;
                const response = await fetch(url); const data = await response.json();
                if (!data.query?.pages) throw new Error(strings['gallery-error']);
                grid.innerHTML = '';
                Object.values(data.query.pages).forEach(page => {
                    if(page.imageinfo) {
                        const item = document.createElement('div'); item.className = 'gallery-item';
                        item.innerHTML = `<img src="${page.imageinfo[0].url}" loading="lazy">`;
                        grid.appendChild(item);
                    }
                });
            } catch (error) { grid.innerHTML = `<p>${error.message}</p>`; }
            finally { loader.style.display = 'none'; }
        };

        const showShareModal = (title, pageid, lang) => {
            const url = `https://${lang}.wikipedia.org/?curid=${pageid}`;
            const strings = uiStrings[lang] || uiStrings.en;
            const shareText = encodeURIComponent(`I found this interesting result about "${title}":`);

            document.getElementById('share-link-input').value = url;
            document.getElementById('share-whatsapp').href = `https://api.whatsapp.com/send?text=${shareText} ${url}`;
            document.getElementById('share-twitter').href = `https://twitter.com/intent/tweet?text=${shareText}&url=${url}`;
            document.getElementById('share-facebook').href = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
            
            qrcodeContainer.innerHTML = '';
            if (qrCode) qrCode.clear();
            qrCode = new QRCode(qrcodeContainer, { text: url, width: 180, height: 180 });
            
            document.getElementById('copy-link-btn').textContent = strings['copy-link'];
            shareModalOverlay.style.display = 'flex';
        };
        
        const initVoiceSearch = () => {
            const voiceSearchBtn = document.getElementById('voiceSearchBtn');
            const searchBar = document.getElementById('search-bar');
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                voiceSearchBtn.style.display = 'none';
                return;
            }
            const recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;

            voiceSearchBtn.addEventListener('click', () => {
                recognition.lang = langSelect.value;
                recognition.start();
            });

            recognition.onstart = () => {
                voiceSearchBtn.classList.add('listening');
                searchBar.classList.add('listening');
            };
            
            recognition.onend = () => {
                voiceSearchBtn.classList.remove('listening');
                searchBar.classList.remove('listening');
            };
            
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                searchInput.value = transcript;
                setTimeout(performSearch, 300);
            };

            recognition.onerror = (event) => {
                console.error("Speech recognition error:", event.error);
            };
        };

        // --- Event Listeners & Initializers ---
        const init3dCardEffect = () => {
            document.querySelectorAll('.card-3d-container').forEach(c => {
                const card = c.querySelector('.result-card');
                c.addEventListener('mousemove', e => {
                    const rect = c.getBoundingClientRect(), x = e.clientX - rect.left, y = e.clientY - rect.top;
                    const rotateX = (y - rect.height/2)/20, rotateY = (rect.width/2 - x)/20;
                    card.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
                    card.style.setProperty('--mx', `${(x/rect.width)*100}%`); card.style.setProperty('--my', `${(y/rect.height)*100}%`);
                });
                c.addEventListener('mouseleave', () => card.style.transform = 'rotateX(0deg) rotateY(0deg)');
            });
        };

        const init = () => {
            const preferredLang = localStorage.getItem('preferredLang') || 'ar';
            setLanguage(preferredLang);

            langSelect.addEventListener('change', () => setLanguage(langSelect.value));
            document.getElementById('searchButton').addEventListener('click', performSearch);
            searchInput.addEventListener('keyup', e => e.key === 'Enter' && performSearch());
            document.addEventListener('mousemove', e => { cursorGlow.style.transform = `translate(${e.clientX}px, ${e.clientY}px)`; });

            searchInput.addEventListener('input', () => {
                if (searchInput.value.trim() === '') {
                    resultsList.innerHTML = '';
                    mainContentWrapper.style.display = 'block';
                }
            });

            resultsList.addEventListener('click', e => {
                const button = e.target.closest('button'); if (!button) return;
                const card = button.closest('.result-card'); if (!card) return;
                const { pageid, title } = card.dataset;
                const lang = langSelect.value;
                if (button.classList.contains('btn-gallery')) showGallery(title, lang);
                if (button.classList.contains('btn-share')) showShareModal(title, pageid, lang);
            });

            document.getElementById('gallery-close-btn').onclick = () => fullscreenGallery.style.display = 'none';
            document.getElementById('modal-close-btn').onclick = () => shareModalOverlay.style.display = 'none';
            shareModalOverlay.addEventListener('click', e => { if (e.target === shareModalOverlay) shareModalOverlay.style.display = 'none'; });

            document.getElementById('copy-link-btn').addEventListener('click', function() {
                const linkInput = document.getElementById('share-link-input');
                linkInput.select();
                navigator.clipboard.writeText(linkInput.value);
                const lang = langSelect.value;
                const strings = uiStrings[lang] || uiStrings.en;
                this.textContent = strings['copied-link'];
            });
            
            initVoiceSearch();
        };

        init();
    });
    </script>
</body>
</html>
