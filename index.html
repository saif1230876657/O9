<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>البوابة المعرفية المتكاملة</title>
    <style>
        :root {
            --bg-color: #020010; --primary-color: #00f2ea; --secondary-color: #d400ff;
            --glass-bg: rgba(15, 10, 35, 0.6); --border-color: rgba(0, 242, 234, 0.25);
            --text-color: #f0f0f0; --text-secondary: #b0b0c0; --glow-color: rgba(0, 242, 234, 0.7);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-color); }
        .background-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; overflow: hidden; background: var(--bg-color); }
        .stars { background: black url(https://s3-us-west-2.amazonaws.com/s.cdpn.io/1231630/stars.png) repeat; position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; z-index: -1; animation: move-stars 80s linear infinite; }
        @keyframes move-stars { from { background-position: 0 0; } to { background-position: 0 -10000px; } }
        
        /* --- HEADER --- */
        .sticky-header-container { position: sticky; top: 0; z-index: 100; background: rgba(2, 0, 16, 0.85); backdrop-filter: blur(20px); padding: 0.75rem 0; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        .header-content { width: 95%; max-width: 1400px; margin: 0 auto; display: flex; align-items: center; gap: 1rem; }
        header { display: flex; align-items: center; gap: 1rem; }
        header h1 { font-size: 1.8rem; background: -webkit-linear-gradient(45deg, var(--primary-color), #fff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header-actions button { background: var(--glass-bg); border: 1px solid var(--border-color); color: var(--text-color); width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .search-wrapper { flex-grow: 1; }
        .search-bar { width: 100%; display: flex; align-items: center; background: var(--glass-bg); border: 1px solid var(--border-color); border-radius: 50px; }
        #searchInput, #langSelect { background: transparent; border: none; outline: none; color: var(--text-color); }
        #searchInput { width: 100%; padding: 0.7rem 1.2rem; font-size: 1rem; }
        #langSelect { border-left: 1px solid var(--border-color); padding: 0 1rem; cursor: pointer; }
        .icon-button { background: transparent; border: none; padding: 0 1rem; cursor: pointer; color: var(--text-secondary); }
        .icon-button svg { width: 20px; height: 20px; vertical-align: middle; }
        
        /* --- MAIN LAYOUT --- */
        .main-layout { display: grid; grid-template-columns: 380px 1fr; gap: 2rem; width: 95%; max-width: 1400px; margin: 2rem auto; align-items: flex-start; }
        #results-sidebar { display: flex; flex-direction: column; gap: 1rem; }
        #main-content-viewer { position: sticky; top: 110px; min-height: 75vh; background: var(--glass-bg); border-radius: 20px; border: 1px solid var(--border-color); padding: 2rem; overflow-y: auto; max-height: calc(100vh - 130px); }
        
        /* --- SIDEBAR CARD (Holographic) --- */
        .card-container { perspective: 800px; }
        .result-card { background: rgba(15, 10, 35, 0.4); border: 1px solid var(--border-color); border-radius: 15px; padding: 1.2rem; cursor: pointer; transition: all 0.2s ease-out; transform-style: preserve-3d; }
        .card-container:hover .result-card { transform: rotateX(5deg) rotateY(-5deg) scale(1.05); border-color: var(--primary-color); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .result-card.active { border-color: var(--primary-color); background: var(--glass-bg); }
        .result-card h3 { font-size: 1.2rem; margin-bottom: 0.5rem; transform: translateZ(20px); }
        .result-card p { font-size: 0.9rem; line-height: 1.6; color: var(--text-secondary); margin-bottom: 1rem; transform: translateZ(10px); }
        .card-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .card-actions button { background: rgba(0,0,0,0.2); border: 1px solid var(--border-color); color: var(--text-secondary); padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.8rem; cursor: pointer; display: inline-flex; align-items: center; gap: 0.4rem; }
        .card-actions button.saved { color: var(--primary-color); border-color: var(--primary-color); }
        
        /* --- MAIN CONTENT & MODALS --- */
        .welcome-message, .loader { text-align: center; padding: 5rem 2rem; }
        .loader-inner { width: 40px; height: 40px; border: 4px solid var(--border-color); border-top: 4px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; }
        .ai-insight-box { /* ... styles from previous version ... */ }
        .details-text p { font-size: 1.1rem; line-height: 2.2; color: var(--text-secondary); margin-bottom: 1.5rem; }
        .modal { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(2, 0, 16, 0.8); backdrop-filter: blur(15px); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: #0a061a; border: 1px solid var(--border-color); width: 90%; max-width: 500px; border-radius: 20px; padding: 1.5rem; }
    </style>
</head>
<body>
    <div class="background-container"><div class="stars"></div></div>
    <div class="sticky-header-container">
        <div class="header-content">
            <header>
                <h1>البوابة الذكية</h1>
                <div class="header-actions">
                    <button id="savedBtn" title="المقالات المحفوظة"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg></button>
                </div>
            </header>
            <div class="search-wrapper">
                <div class="search-bar">
                    <select id="langSelect"><option value="ar">العربية</option><option value="en">English</option><option value="fr">Français</option><option value="es">Español</option></select>
                    <input type="text" id="searchInput" placeholder="استكشف بكلمة...">
                </div>
            </div>
        </div>
    </div>

    <main class="main-layout">
        <aside id="results-sidebar"></aside>
        <main id="main-content-viewer"><div class="welcome-message"><h2>استكشف المعرفة</h2></div></main>
    </main>

    <div id="shareModal" class="modal"><div class="modal-content"></div></div>
    <div id="savedModal" class="modal"><div class="modal-content"></div></div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const searchInput = document.getElementById('searchInput');
        const langSelect = document.getElementById('langSelect');
        const resultsSidebar = document.getElementById('results-sidebar');
        const mainContentViewer = document.getElementById('main-content-viewer');
        const savedBtn = document.getElementById('savedBtn');
        const shareModal = document.getElementById('shareModal');
        const savedModal = document.getElementById('savedModal');
        const welcomeMessageHTML = mainContentViewer.innerHTML;

        let allArticlesData = {};

        // --- Save & Share & Language Logic ---
        const getSavedArticles = () => JSON.parse(localStorage.getItem('savedArticles') || '[]');
        const isArticleSaved = (pageid) => getSavedArticles().some(a => a.pageid == pageid);
        const saveArticle = (article) => {
            const saved = getSavedArticles();
            if (!isArticleSaved(article.pageid)) saved.push(article);
            localStorage.setItem('savedArticles', JSON.stringify(saved));
        };
        const removeArticle = (pageid) => {
            let saved = getSavedArticles();
            saved = saved.filter(a => a.pageid != pageid);
            localStorage.setItem('savedArticles', JSON.stringify(saved));
        };
        const savedLang = localStorage.getItem('preferredLang');
        if (savedLang) langSelect.value = savedLang;
        langSelect.addEventListener('change', () => localStorage.setItem('preferredLang', langSelect.value));

        // --- Search Logic ---
        const performSearch = async () => {
            const query = searchInput.value.trim();
            if (!query) return;
            resultsSidebar.innerHTML = '<div class="loader"><div class="loader-inner"></div></div>';
            mainContentViewer.innerHTML = welcomeMessageHTML;
            try {
                const lang = langSelect.value;
                const url = `https://${lang}.wikipedia.org/w/api.php?action=query&origin=*&format=json&generator=search&gsrnamespace=0&gsrlimit=5&gsrsearch=${encodeURIComponent(query)}&prop=extracts|pageimages&exintro=1&explaintext=1&piprop=thumbnail&pithumbsize=100`;
                const response = await fetch(url);
                const data = await response.json();
                if (!data.query || !data.query.pages) throw new Error('لا توجد نتائج.');
                
                allArticlesData = data.query.pages;
                resultsSidebar.innerHTML = '';
                Object.values(allArticlesData).sort((a,b) => a.index - b.index).forEach(page => createResultCard(page));
            } catch (error) { resultsSidebar.innerHTML = `<p>${error.message}</p>`; }
        };

        const createResultCard = (page) => {
            const isSaved = isArticleSaved(page.pageid);
            const container = document.createElement('div');
            container.className = 'card-container';

            const card = document.createElement('div');
            card.className = 'result-card';
            card.dataset.pageid = page.pageid;
            card.innerHTML = `
                <h3>${page.title}</h3>
                <p>${page.extract ? page.extract.substring(0, 150) + '...' : ''}</p>
                <div class="card-actions">
                    <button class="share-btn">مشاركة</button>
                    <button class="save-btn ${isSaved ? 'saved' : ''}">${isSaved ? 'محفوظ' : 'حفظ'}</button>
                </div>`;
            
            container.appendChild(card);
            resultsSidebar.appendChild(container);
            
            // Event Listeners
            card.addEventListener('click', (e) => {
                if (!e.target.closest('button')) {
                    document.querySelectorAll('.result-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    displayDetails(page.pageid);
                }
            });
            card.querySelector('.share-btn').addEventListener('click', () => showShareModal(page));
            card.querySelector('.save-btn').addEventListener('click', (e) => {
                const btn = e.target;
                if(isArticleSaved(page.pageid)) {
                    removeArticle(page.pageid);
                    btn.textContent = 'حفظ';
                    btn.classList.remove('saved');
                } else {
                    saveArticle({pageid: page.pageid, title: page.title, thumbnail: page.thumbnail ? page.thumbnail.source : ''});
                    btn.textContent = 'محفوظ';
                    btn.classList.add('saved');
                }
            });
        };

        const displayDetails = async (pageid) => {
             mainContentViewer.innerHTML = '<div class="loader"><div class="loader-inner"></div></div>';
            try {
                const lang = langSelect.value;
                const articleFromCache = allArticlesData[pageid];
                const intelligentIconUrl = articleFromCache.thumbnail ? articleFromCache.thumbnail.source : '';

                const url = `https://${lang}.wikipedia.org/w/api.php?action=query&origin=*&format=json&pageids=${pageid}&prop=extracts&explaintext=1`;
                const response = await fetch(url);
                const data = await response.json();
                const pageData = data.query.pages[pageid];
                const fullText = pageData.extract;
                
                mainContentViewer.innerHTML = `
                    <div class="ai-insight-box">
                         <div class="ai-insight-header">
                            <img src="${intelligentIconUrl}" style="width:40px;height:40px;border-radius:8px;object-fit:cover;" alt="Icon">
                            <h2>تحليل بالذكاء الاصطناعي</h2>
                        </div>
                        <div class="ai-tabs">
                            <button class="ai-tab active" data-tab="summary">ملخص ذكي</button>
                        </div>
                        <div id="summary" class="ai-content active"></div>
                    </div>
                    <div class="section-divider">✦✦✦ النص الكامل ✦✦✦</div>
                    <div class="details-text">
                        ${fullText.split('\n\n').filter(p => p.trim() !== '').map(p => `<p>${p}</p>`).join('')}
                    </div>`;

                // Generate summary
                const sentences = fullText.split('. ');
                const summaryPoints = sentences.slice(0, 5).map(s => `<li>${s.trim()}.</li>`).join('');
                document.getElementById('summary').innerHTML = `<ul class="ai-summary-list">${summaryPoints}</ul>`;

            } catch (error) { mainContentViewer.innerHTML = `<p>Error: ${error.message}</p>`; }
        };

        // --- Modal Logic ---
        const showShareModal = (page) => {
             const shareUrl = `${window.location.origin}${window.location.pathname}?query=${encodeURIComponent(page.title)}&lang=${langSelect.value}`;
             shareModal.querySelector('.modal-content').innerHTML = `
                <h3>مشاركة "${page.title}"</h3>
                <input type="text" value="${shareUrl}" readonly style="width:100%; padding:0.5rem; margin:1rem 0;">
                <button id="copyBtn">نسخ الرابط</button>`;
             shareModal.style.display = 'flex';
             document.getElementById('copyBtn').onclick = () => navigator.clipboard.writeText(shareUrl).then(() => alert('تم النسخ!'));
        };
        
        savedBtn.addEventListener('click', () => {
            const saved = getSavedArticles();
            savedModal.querySelector('.modal-content').innerHTML = `
                <h3>المقالات المحفوظة</h3>
                <ul style="list-style:none; padding:1rem 0;">
                    ${saved.length ? saved.map(a => `<li>${a.title}</li>`).join('') : '<p>لا يوجد شيء محفوظ.</p>'}
                </ul>`;
            savedModal.style.display = 'flex';
        });

        [shareModal, savedModal].forEach(modal => {
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });
        });
        
        searchInput.addEventListener('keyup', e => e.key === 'Enter' && performSearch());
    });
    </script>
</body>
</html>
