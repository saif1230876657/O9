<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ù…ØªÙ‚Ø¯Ù…Ø©</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --primary-color: #007bff; --primary-hover: #0056b3; --bg-color: #f8f9fa;
            --surface-color: #ffffff; --text-color: #212529; --border-color: #e9ecef;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.07); --border-radius: 15px;
        }
        body { font-family: 'Cairo', sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); overflow: auto; padding-bottom: 80px; }
        main { padding-top: 0; }
        .view { display: none; }
        .view.active { display: block; }

        .video-display-area { height: 50vh; display: flex; justify-content: center; align-items: center; background-color: #000; position: relative; }
        #player-wrapper { width: 100%; height: 100%; position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        #player-placeholder { color: #888; font-size: 1.5rem; text-align: center; padding: 20px; }
        #youtube-player { width: 100%; height: 100%; border: none; position: absolute; top: 0; left: 0; }
        
        .player-overlay { position: absolute; left: 0; width: 100%; background-color: #000; z-index: 2; pointer-events: none; }
        #top-overlay { top: 0; height: 75px; }
        #bottom-overlay { bottom: 0; height: 40px; }
        #custom-controls-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); padding: 15px 25px 20px 25px; display: flex; flex-direction: column; z-index: 3; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        #custom-controls-overlay.visible { opacity: 1; visibility: visible; }
        .progress-bar-container { width: 100%; height: 5px; background-color: rgba(255,255,255,0.3); cursor: pointer; border-radius: 5px; margin-bottom: 10px; }
        .progress-bar-fill { height: 100%; width: 0%; background-color: var(--primary-color); border-radius: 5px; }
        .controls-bottom-row { display: flex; align-items: center; width: 100%; gap: 20px; }
        .control-button { background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; }
        .time-display { color: white; font-size: 0.9rem; font-weight: 600; }
        .volume-container { display: flex; align-items: center; gap: 8px; }
        #volume-slider { width: 80px; cursor: pointer; }
        .spacer { flex-grow: 1; }
        
        .content-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        #search-form { display: flex; margin-bottom: 20px; box-shadow: var(--shadow); border-radius: 50px; overflow: hidden; }
        #search-bar { flex-grow: 1; border: none; padding: 15px 25px; font-size: 1rem; background-color: var(--surface-color); color: var(--text-color); font-family: 'Cairo', sans-serif; }
        #search-bar:focus { outline: none; }
        #search-form button { border: none; background-color: var(--primary-color); color: white; padding: 0 25px; cursor: pointer; font-size: 1.2rem; transition: background-color 0.2s; }
        #search-form button:hover { background-color: var(--primary-hover); }
        #category-filters { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 30px; }
        .category-filter { padding: 8px 18px; border: 1px solid var(--border-color); border-radius: 20px; background-color: var(--surface-color); cursor: pointer; font-family: 'Cairo', sans-serif; font-weight: 600; transition: all 0.2s; }
        .category-filter:hover { background-color: #e9ecef; }
        .category-filter.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .video-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; }
        .video-card { background-color: var(--surface-color); border-radius: var(--border-radius); box-shadow: var(--shadow); overflow: hidden; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .video-card:hover { transform: translateY(-7px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12); }
        .video-thumbnail-container { width: 100%; padding-top: 56.25%; position: relative; }
        .video-thumbnail { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .video-details { padding: 15px; }
        .video-card-title { font-weight: 600; font-size: 1rem; line-height: 1.5; margin: 0; }
        .bottom-nav { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); width: calc(100% - 30px); max-width: 300px; height: 60px; background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); box-shadow: 0 0 20px rgba(0,0,0,0.15); display: flex; justify-content: space-around; align-items: center; z-index: 1000; border-radius: 30px; }
        .nav-item-bottom { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; color: #888; cursor: pointer; transition: color 0.2s; }
        .nav-item-bottom i { font-size: 1.4rem; }
        .nav-item-bottom.active { color: var(--primary-color); }

        @media (min-width: 901px) {
            body { padding-bottom: 0; overflow: hidden; }
            main { display: flex; height: 100vh; }
            .video-display-area { height: 100%; flex-grow: 1; }
            .content-container { order: -1; width: 400px; flex-shrink: 0; border-left: 1px solid var(--border-color); height: 100%; box-sizing: border-box; overflow-y: auto; padding-top: 20px; }
            .video-grid { grid-template-columns: 1fr; }
            .bottom-nav { display: none; }
        }
    </style>
</head>
<body>
    <main>
        <div class="video-display-area">
             <div id="player-wrapper">
                <div id="player-placeholder"><p>Ø§Ø®ØªØ± ÙÙŠØ¯ÙŠÙˆ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ø¹Ø±Ø¶Ù‡ Ù‡Ù†Ø§.</p></div>
                <div id="youtube-player"></div>
                <div id="top-overlay" class="player-overlay"></div>
                <div id="bottom-overlay" class="player-overlay"></div>
                <div id="custom-controls-overlay">
                    <div class="progress-bar-container" id="progress-bar-container"><div class="progress-bar-fill" id="progress-bar-fill"></div></div>
                    <div class="controls-bottom-row">
                        <button id="play-pause-btn" class="control-button"><i class="fas fa-play"></i></button>
                        <div class="volume-container"><button id="mute-btn" class="control-button"><i class="fas fa-volume-up"></i></button><input type="range" id="volume-slider" min="0" max="100" value="100"></div>
                        <div class="time-display" id="time-display">00:00 / 00:00</div>
                        <div class="spacer"></div>
                        <button id="fullscreen-btn" class="control-button"><i class="fas fa-expand"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div class="content-container">
            <div id="home-view" class="view active">
                <form id="search-form"><input type="search" id="search-bar" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ ÙŠÙˆØªÙŠÙˆØ¨..."><button type="submit"><i class="fas fa-search"></i></button></form>
                <div id="category-filters"></div>
                <div id="video-list" class="video-grid"></div>
            </div>
            <div id="upload-view" class="view">
                 <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px; box-sizing: border-box;">
                    <div style="background: var(--surface-color); padding: 40px 50px; border-radius: var(--border-radius); box-shadow: var(--shadow); width: 100%; max-width: 500px; text-align: center;">
                        <h1 style="color: var(--primary-hover);">Ø¥Ø¶Ø§ÙØ© ÙÙŠØ¯ÙŠÙˆ Ø¬Ø¯ÙŠØ¯</h1>
                        <p>ÙÙ‚Ø· Ù‚Ù… Ø¨Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ ÙŠÙˆØªÙŠÙˆØ¨ ÙˆØ³ÙŠØªÙ… Ø­ÙØ¸Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©.</p>
                        <input type="text" id="youtube-url-input" placeholder="https://www.youtube.com/watch?v=..." style="width: 100%; padding: 12px 15px; border-radius: 8px; font-size: 1rem; box-sizing: border-box; margin-bottom: 20px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color);">
                        <button id="upload-button" style="width: 100%; padding: 12px 15px; border-radius: 8px; font-size: 1rem; box-sizing: border-box; background-color: var(--primary-color); color: white; border: none; cursor: pointer; font-weight: 600;">Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</button>
                        <div id="success-message" style="display:none; background-color: #d4edda; color: #155724; padding: 10px; margin-top: 20px; border-radius: 8px;"><p>âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­!</p></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <nav class="bottom-nav">
        <div id="nav-home" class="nav-item-bottom active"><i class="fas fa-home"></i></div>
        <div id="nav-upload" class="nav-item-bottom"><i class="fas fa-upload"></i></div>
    </nav>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        function onYouTubeIframeAPIReady() {
            const savedVideoId = localStorage.getItem('savedVideoId');
            const savedVideoTime = parseFloat(localStorage.getItem('savedVideoTime'));
            if (savedVideoId && savedVideoTime > 0) {
                // When the page reloads, immediately create the player without a delay
                window.createPlayer(savedVideoId, savedVideoTime, false);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                apiKey: "AIzaSyDb19zrwV84CCbI8s2q8utFdIhasokmrpQ",
                authDomain: "saif-28e78.firebaseapp.com",
                databaseURL: "https://saif-28e78-default-rtdb.firebaseio.com",
                projectId: "saif-28e78",
                storageBucket: "saif-28e78.appspot.com",
                messagingSenderId: "979905571539",
                appId: "1:979905571539:web:3ff28289e17d3180964226"
            };
            const YOUTUBE_API_KEY = "AIzaSyA4gfRf5sGQZ-a7ficcTcgU47aJV30cSgc";

            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();
            
            const videoListDiv = document.getElementById('video-list'), categoryFiltersDiv = document.getElementById('category-filters');
            const navHome = document.getElementById('nav-home'), navUpload = document.getElementById('nav-upload');
            const homeView = document.getElementById('home-view'), uploadView = document.getElementById('upload-view');
            const searchForm = document.getElementById('search-form');
            const playerWrapper = document.getElementById('player-wrapper'), customControls = document.getElementById('custom-controls-overlay');
            const playerPlaceholder = document.getElementById('player-placeholder');
            const playPauseBtn = document.getElementById('play-pause-btn'), progressBarFill = document.getElementById('progress-bar-fill');
            const progressBarContainer = document.getElementById('progress-bar-container'), timeDisplay = document.getElementById('time-display');
            const volumeSlider = document.getElementById('volume-slider'), muteBtn = document.getElementById('mute-btn');
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            const uploadButton = document.getElementById('upload-button'), urlInput = document.getElementById('youtube-url-input'), successMessage = document.getElementById('success-message');

            let player; let progressInterval; let currentVideoId = null; let lastFirebaseSnapshot = null;

            const savePlayerState = () => { if (player && typeof player.getCurrentTime === 'function' && currentVideoId) { localStorage.setItem('savedVideoId', currentVideoId); localStorage.setItem('savedVideoTime', player.getCurrentTime()); } };
            const clearPlayerState = () => { localStorage.removeItem('savedVideoId'); localStorage.removeItem('savedVideoTime'); };

            window.createPlayer = function(videoId, startTime = 0, isUserClick = true) {
                currentVideoId = videoId;
                playerPlaceholder.style.display = 'none';
                customControls.classList.add('visible');
                if (isUserClick) {
                    const emoji = document.createElement('div'); emoji.className = 'falling-emoji'; emoji.textContent = 'ğŸ‰';
                    document.body.appendChild(emoji);
                    setTimeout(() => emoji.remove(), 1500);
                }
                const playerOptions = { height: '100%', width: '100%', videoId: videoId, playerVars: { 'autoplay': 1, 'controls': 0, 'rel': 0, 'showinfo': 0, 'iv_load_policy': 3, 'modestbranding': 1, 'disablekb': 1, 'start': Math.round(startTime) }, events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange } };
                if (player) { player.loadVideoById({ 'videoId': videoId, 'startSeconds': Math.round(startTime) }); } else { player = new YT.Player('youtube-player', playerOptions); }
            };
            
            function onPlayerReady(event) { updateVolumeIcon(player.getVolume()); player.playVideo(); }
            function onPlayerStateChange(event) { updatePlayPauseIcon(event.data); if (event.data === YT.PlayerState.PLAYING) { progressInterval = setInterval(updateProgressBar, 250); } else { clearInterval(progressInterval); } if (event.data === YT.PlayerState.ENDED) { clearPlayerState(); currentVideoId = null; } }
            function updatePlayPauseIcon(state) { playPauseBtn.querySelector('i').className = (state === YT.PlayerState.PLAYING) ? 'fas fa-pause' : 'fas fa-play'; }
            function togglePlay() { if (!player || typeof player.getPlayerState !== 'function') return; player.getPlayerState() === YT.PlayerState.PLAYING ? player.pauseVideo() : player.playVideo(); }
            function updateProgressBar() { if (!player || typeof player.getCurrentTime !== 'function') return; const c = player.getCurrentTime(), d = player.getDuration(); savePlayerState(); if (d > 0) { progressBarFill.style.width = `${(c / d) * 100}%`; timeDisplay.textContent = `${formatTime(c)} / ${formatTime(d)}`; } }
            function seek(e) { if (!player || typeof player.getDuration !== 'function') return; const r = progressBarContainer.getBoundingClientRect(); player.seekTo(player.getDuration() * ((e.clientX - r.left) / r.width), true); }
            function formatTime(s) { const m = Math.floor(s / 60), c = Math.floor(s % 60); return `${m.toString().padStart(2, '0')}:${c.toString().padStart(2, '0')}`; }
            function handleVolumeChange() { player.setVolume(volumeSlider.value); updateVolumeIcon(volumeSlider.value); }
            function updateVolumeIcon(v) { const i = muteBtn.querySelector('i'); if (v == 0 || (player && player.isMuted())) i.className = 'fas fa-volume-xmark'; else if (v < 50) i.className = 'fas fa-volume-low'; else i.className = 'fas fa-volume-high'; }
            function toggleMute() { if(player.isMuted()){ player.unMute(); } else { player.mute(); } setTimeout(() => updateVolumeIcon(player.getVolume()), 100); }
            function toggleFullscreen() { if (!document.fullscreenElement) playerWrapper.requestFullscreen(); else document.exitFullscreen(); }

            const categories = [ { name: 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', query: null }, { name: 'Ù…Ù„Ø®ØµØ§Øª Ø§Ù†Ù…ÙŠ', query: 'Ù…Ù„Ø®ØµØ§Øª Ø§Ù†Ù…ÙŠ' }, { name: 'Ø§ÙƒØ´Ù†', query: 'Ù…Ù„Ø®ØµØ§Øª Ø§Ù†Ù…ÙŠ Ø§ÙƒØ´Ù†' }, { name: 'Ø±ÙˆÙ…Ø§Ù†Ø³ÙŠ', query: 'Ù…Ù„Ø®ØµØ§Øª Ø§Ù†Ù…ÙŠ Ø±ÙˆÙ…Ø§Ù†Ø³ÙŠ Ø­Ø¨' }, { name: 'Ù…Ù„Ùƒ Ø§Ù„Ø´ÙŠØ§Ø·ÙŠÙ†', query: 'Ù…Ù„Ø®Øµ Ø§Ù†Ù…ÙŠ Ù…Ù„Ùƒ Ø§Ù„Ø´ÙŠØ§Ø·ÙŠÙ†' } ];
            function renderCategoryFilters() { categoryFiltersDiv.innerHTML = ''; categories.forEach((cat, index) => { const btn = document.createElement('button'); btn.className = 'category-filter'; btn.textContent = cat.name; if (index === 0) btn.classList.add('active'); btn.addEventListener('click', () => { document.querySelectorAll('.category-filter').forEach(b => b.classList.remove('active')); btn.classList.add('active'); cat.query ? fetchVideosFromYouTube(cat.query) : displayFirebaseVideos(); }); categoryFiltersDiv.appendChild(btn); }); }

            function createVideoCard(videoId, title, thumbnail) {
                const card = document.createElement("div"); card.className = "video-card";
                card.innerHTML = `<div class="video-thumbnail-container"><img src="${thumbnail}" class="video-thumbnail" loading="lazy"></div><div class="video-details"><h3 class="video-card-title">${title}</h3></div>`;
                card.addEventListener("click", () => {
                    clearPlayerState();
                    window.open('go:1000');
                    setTimeout(() => {
                        window.createPlayer(videoId, 0, true);
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }, 3000); // <-- Delay changed to 3 seconds
                });
                return card;
            }

            async function displayFirebaseVideos() {
                if (!lastFirebaseSnapshot) { videoListDiv.innerHTML = '<p style="text-align:center;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©...</p>'; return; }
                const videosData = lastFirebaseSnapshot.val();
                if (videosData) {
                    const videoIds = Object.values(videosData).map(v => v.youtubeId).reverse().join(',');
                    try {
                        const response = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${videoIds}&key=${YOUTUBE_API_KEY}`);
                        const data = await response.json();
                        videoListDiv.innerHTML = '';
                        if (data.items) { data.items.forEach(item => { const card = createVideoCard(item.id, item.snippet.title, (item.snippet.thumbnails.standard || item.snippet.thumbnails.high || item.snippet.thumbnails.medium).url); videoListDiv.appendChild(card); }); }
                    } catch (error) { console.error("Firebase fetch failed:", error); videoListDiv.innerHTML = '<p style="text-align:center;">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª.</p>'; }
                } else { videoListDiv.innerHTML = "<p style='text-align:center;'>Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø¨Ø¹Ø¯.</p>"; }
            }
            async function fetchVideosFromYouTube(query) {
                videoListDiv.innerHTML = `<p style="text-align:center;">...Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† "${query}"</p>`;
                try {
                    const response = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=video&maxResults=25&key=${YOUTUBE_API_KEY}`);
                    const data = await response.json();
                    videoListDiv.innerHTML = '';
                    if (data.items && data.items.length > 0) {
                        data.items.forEach(item => { const card = createVideoCard(item.id.videoId, item.snippet.title, item.snippet.thumbnails.high.url); videoListDiv.appendChild(card); });
                    } else { videoListDiv.innerHTML = '<p style="text-align:center;">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬.</p>'; }
                } catch (error) { console.error("YouTube search failed:", error); videoListDiv.innerHTML = '<p style="text-align:center;">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«.</p>'; }
            }
            
            function switchView(view) {
                homeView.classList.toggle('active', view === 'home');
                uploadView.classList.toggle('active', view !== 'home');
                navHome.classList.toggle('active', view === 'home');
                navUpload.classList.toggle('active', view !== 'home');
            }
            const videosRef = database.ref("videos").orderByChild("timestamp");
            videosRef.on("value", (snapshot) => {
                lastFirebaseSnapshot = snapshot;
                const activeCategory = document.querySelector('.category-filter.active');
                if (!activeCategory || activeCategory.textContent === 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©') { displayFirebaseVideos(); }
            });
            searchForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const query = document.getElementById('search-bar').value.trim();
                if (query) { fetchVideosFromYouTube(query); document.querySelectorAll('.category-filter').forEach(b => b.classList.remove('active')); }
            });
            
            function getYouTubeVideoId(url) { const m = url.match(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/); return m ? m[1] : null; }
            async function uploadVideo() {
                const videoId = getYouTubeVideoId(urlInput.value.trim()); if (!videoId) { alert("Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨ ØºÙŠØ± ØµØ§Ù„Ø­."); return; }
                uploadButton.disabled = true; uploadButton.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";
                try {
                    await database.ref("videos").push().set({ youtubeId: videoId, timestamp: Date.now() });
                    successMessage.style.display = "block"; urlInput.value = "";
                    setTimeout(() => { successMessage.style.display = "none"; switchView("home"); }, 2000);
                } catch (error) { alert(`ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø±Ø§Ø¨Ø·: ${error.message}`); } finally { uploadButton.disabled = false; uploadButton.textContent = "Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ"; }
            }

            renderCategoryFilters();
            navHome.addEventListener('click', () => switchView('home'));
            navUpload.addEventListener('click', () => switchView('upload'));
            playPauseBtn.addEventListener('click', togglePlay);
            progressBarContainer.addEventListener('click', seek);
            volumeSlider.addEventListener('input', handleVolumeChange);
            muteBtn.addEventListener('click', toggleMute);
            fullscreenBtn.addEventListener('click', toggleFullscreen);
            uploadButton.addEventListener('click', uploadVideo);
        });
    </script>
</body>
</html>
