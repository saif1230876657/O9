<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المساعد الصوتي | Physics Engine</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script type="importmap">
      { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@700&display=swap');
        :root {
            --background-color: #ffffff; --main-color: #000000;
            --border-color: #e0e0e0; --text-color: #aaaaaa;
        }
        body {
            background-color: var(--background-color); margin: 0; height: 100vh;
            display: flex; justify-content: center; align-items: center;
            font-family: 'Cairo', sans-serif; overflow: hidden;
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewport="0 0 100 100" style="fill:black;"><circle cx="10" cy="10" r="10" /></svg>') 10 10, auto;
        }
        canvas {
            position: absolute; top: 0; left: 0; z-index: 0;
        }
        .controls, .status { z-index: 1; } /* للتأكد من أن الأزرار والنص فوق الكانفاس */
        .controls { position: absolute; bottom: 50px; display: flex; align-items: center; gap: 25px; }
        #talkButton {
            width: 80px; height: 80px; border-radius: 50%; border: 4px solid var(--border-color);
            background-color: var(--main-color); cursor: pointer; display: flex; justify-content: center; align-items: center;
            transition: transform 0.2s ease, background-color 0.2s ease; box-shadow: 0px 8px 25px rgba(0, 0, 0, 0.1);
        }
        #talkButton.listening { background-color: #d32f2f; animation: pulse 1.5s infinite; }
        #talkButton:hover { transform: scale(1.1); }
        #talkButton svg { width: 40px; height: 40px; fill: #ffffff; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(211, 47, 47, 0); }
            100% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0); }
        }
        #stopButton {
            width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--border-color);
            background-color: transparent; color: #ccc; cursor: pointer; font-size: 24px;
            font-weight: bold; display: flex; justify-content: center; align-items: center; transition: all 0.2s ease;
        }
        #stopButton:hover { border-color: var(--main-color); color: var(--main-color); transform: scale(1.1) rotate(90deg); }
        .status { position: absolute; top: 40px; font-size: 1.2em; color: var(--text-color); }
    </style>
</head>
<body>
    <canvas id="physics-canvas"></canvas>
    <div class="status" id="status">اضغط للتحدث</div>
    <div class="controls">
        <button id="stopButton" title="إيقاف الكل">X</button>
        <button id="talkButton" title="اضغط للتحدث">
            <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.49 6-3.31 6-6.72h-1.7z"/></svg>
        </button>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // --- إعدادات الذكاء الاصطناعي والصوت (لا تغيير) ---
        const API_KEY = "AIzaSyAnAUCajzM7PqrM6k5znxaOAKs3R1kHzWk";
        const genAI = new GoogleGenerativeAI(API_KEY);
        const model = genAI.getGenerativeModel({ 
            model: "gemini-1.5-flash",
            systemInstruction: "أنت مساعد ذكاء اصطناعي لطيف ومفيد للغاية. لديك شخصية مرحة ومستعدة للمساعدة دائمًا. اجعل ردودك واضحة وودودة باللغة العربية.",
        });
        const chat = model.startChat();
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = SpeechRecognition ? new SpeechRecognition() : null;
        const synthesis = window.speechSynthesis;
        
        const talkButton = document.getElementById('talkButton');
        const stopButton = document.getElementById('stopButton');
        const statusDiv = document.getElementById('status');
        
        let audioContext, analyser;
        let isListening = false;
        let currentVolume = 0;
        let emojiParticles = [];

        // --- إعداد المحرك الفيزيائي Matter.js ---
        const { Engine, Render, Runner, Bodies, Composite, Constraint, Mouse, MouseConstraint, Events } = Matter;
        const engine = Engine.create({ gravity: { x: 0, y: 0 } });
        const canvas = document.getElementById('physics-canvas');
        const render = Render.create({
            canvas: canvas, engine: engine,
            options: { width: window.innerWidth, height: window.innerHeight, wireframes: false, background: 'transparent' }
        });
        const runner = Runner.create();

        // إنشاء جسيمات "فينوم"
        const particles = [];
        const center = { x: window.innerWidth / 2, y: window.innerHeight / 2 };
        for (let i = 0; i < 40; i++) {
            const particle = Bodies.circle(center.x + (Math.random() - 0.5) * 50, center.y + (Math.random() - 0.5) * 50, 15, {
                frictionAir: 0.05,
                render: { fillStyle: '#000' }
            });
            particles.push(particle);
            // ربط كل جسيم بالمركز بقيد مرن (كالمغناطيس)
            const constraint = Constraint.create({
                pointA: center, bodyB: particle,
                stiffness: 0.005, damping: 0.1,
            });
            Composite.add(engine.world, constraint);
        }
        Composite.add(engine.world, particles);

        // التفاعل مع الماوس
        const mouse = Mouse.create(render.canvas);
        const mouseConstraint = MouseConstraint.create(engine, {
            mouse: mouse, constraint: { stiffness: 0.2, render: { visible: false } }
        });
        Composite.add(engine.world, mouseConstraint);

        // --- الحلقة الفيزيائية الرئيسية (قلب التفاعل) ---
        Events.on(engine, 'beforeUpdate', (event) => {
            particles.forEach(p => {
                // 1. قوة الصد من الماوس
                const dist = Matter.Vector.magnitude(Matter.Vector.sub(p.position, mouse.position));
                if (dist < 100) {
                    const force = Matter.Vector.mult(Matter.Vector.normalise(Matter.Vector.sub(p.position, mouse.position)), 0.01);
                    Matter.Body.applyForce(p, p.position, force);
                }
            });
             // 2. قوة الاهتزاز من الصوت
            if (currentVolume > 10) {
                const chaos = currentVolume / 128 * 0.005;
                particles.forEach(p => Matter.Body.applyForce(p, p.position, {
                    x: (Math.random() - 0.5) * chaos, y: (Math.random() - 0.5) * chaos
                }));
                // 3. إطلاق الإيموجيات عند الصوت العالي
                if (currentVolume > 60 && Math.random() < 0.2) {
                    spawnEmoji();
                }
            }
        });
        
        // رسم الإيموجيات
        Events.on(render, 'afterRender', () => {
            const ctx = render.context;
            ctx.font = '20px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            emojiParticles.forEach((p, i) => {
                ctx.fillText('⚡', p.position.x, p.position.y);
                p.lifespan--;
                if (p.lifespan <= 0) {
                    Composite.remove(engine.world, p);
                    emojiParticles.splice(i, 1);
                }
            });
        });

        Render.run(render);
        Runner.run(runner, engine);

        // --- وظائف الصوت والتفاعل ---
        const setupAudioAnalysis = async () => { /* ... نفس الكود ... */ };
        const analyzeVolume = () => {
            if (!analyser) return;
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);
            currentVolume = dataArray.reduce((acc, val) => acc + val, 0) / dataArray.length;
            requestAnimationFrame(analyzeVolume);
        };
        const speak = (text) => { /* ... نفس الكود ... */ };

        const handleInteraction = async () => {
            if (isListening) return;
            if (synthesis.speaking) synthesis.cancel();
            await setupAudioAnalysis();
            if (!audioContext) return;
            isListening = true;
            talkButton.classList.add('listening');
            statusDiv.textContent = "استمع إليك...";
            recognition.start();
            analyzeVolume();
            recognition.onresult = async (event) => { /* ... نفس الكود ... */ };
            recognition.onend = () => stopAllActivities(false);
            recognition.onerror = (event) => stopAllActivities(true, event.error);
        };
        
        const stopAllActivities = (withError = false, errorMsg = '') => {
            currentVolume = 0; // إيقاف الاهتزاز
            isListening = false;
            // ... باقي الكود من الإصدار السابق ...
        };
        
        const spawnEmoji = () => {
            const emoji = Bodies.circle(center.x, center.y, 5, {
                frictionAir: 0.02, render: { visible: false } // الإيموجي غير مرئي للمحرك، نرسمه بأنفسنا
            });
            emoji.lifespan = 60; // عمر الإيموجي بالـ frames
            Matter.Body.applyForce(emoji, emoji.position, {
                x: (Math.random() - 0.5) * 0.05, y: (Math.random() - 0.5) * 0.05
            });
            emojiParticles.push(emoji);
            Composite.add(engine.world, emoji);
        };

        // --- الربط مع الأزرار والإعدادات الأولية ---
        talkButton.addEventListener('click', handleInteraction);
        stopButton.addEventListener('click', () => stopAllActivities(false));
        window.addEventListener('resize', () => { /* يمكن إضافة كود لتحديث أبعاد الكانفاس هنا */ });

        // --- إعادة لصق الوظائف التي لم تتغير لضمان اكتمال الكود ---
        recognition.lang = 'ar-SA'; recognition.continuous = false;
        async function setupAudioAnalysis() {
            if (audioContext) return;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new AudioContext();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                analyser.fftSize = 256;
            } catch (err) { statusDiv.textContent = "لا يمكن الوصول إلى المايكروفون."; }
        }
        function speak(text) {
            synthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            const voices = synthesis.getVoices();
            utterance.voice = voices.find(v => v.lang.startsWith('ar')) || voices[0];
            utterance.onstart = () => { statusDiv.textContent = "يتحدث..."; };
            utterance.onend = () => { if (!isListening) { statusDiv.textContent = "اضغط للتحدث"; }};
            synthesis.speak(utterance);
        }
        function stopAllActivities(withError = false, errorMsg = '') {
            currentVolume = 0;
            isListening = false;
            if (recognition) recognition.stop();
            if (synthesis) synthesis.cancel();
            talkButton.classList.remove('listening');
            if (withError) { statusDiv.textContent = errorMsg === 'no-speech' ? "لم أسمع شيئًا" : "حدث خطأ"; }
            else if (!statusDiv.textContent.includes("يتحدث")) { statusDiv.textContent = "اضغط للتحدث"; }
        }
        recognition.onresult = async (event) => {
            const transcript = event.results[0][0].transcript;
            statusDiv.textContent = "لحظة، أفكر...";
            try {
                const result = await chat.sendMessage(transcript);
                speak(result.response.text());
            } catch (error) { speak("عذراً، حدث خطأ أثناء الاتصال بالذكاء الاصطناعي."); }
        };

    </script>
</body>
</html>
