<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>مشغّل قرآن — CDN صوتي مباشر</title>
<style>
  :root{--bg:#f7fbf9;--card:#fff;--accent:#176c4a;--muted:#556;--gold:#c69b2b}
  html,body{height:100%;margin:0;font-family:Tahoma,Arial,Helvetica,sans-serif;background:var(--bg);color:#07201a;direction:rtl}
  .wrap{max-width:980px;margin:18px auto;padding:12px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
  h1{margin:0;color:var(--accent)}
  .card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06);margin-bottom:12px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  label{display:block;font-weight:700;margin-bottom:6px}
  select,input,button{padding:8px;border-radius:8px;border:1px solid #e6eef0}
  button{cursor:pointer}
  button.primary{background:var(--accent);color:white;border:0}
  .player{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:12px}
  .bigbtn{padding:10px 14px;border-radius:10px}
  .progress{width:100%;height:10px;background:#eee;border-radius:8px;overflow:hidden;cursor:pointer}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#0f8b5c)}
  .time{font-size:13px;color:var(--muted)}
  footer{margin-top:18px;text-align:center;color:var(--muted)}
  .small{font-size:13px;color:var(--muted)}
  @media(max-width:720px){header{flex-direction:column;align-items:flex-start}}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>مشغّل القرآن (مباشر من CDN)</h1>
      <div class="small">مصدر الصوت: cdn.islamic.network — روابط MP3 جاهزة لكل سورة/آية.</div>
    </header>

    <section class="card">
      <div class="row">
        <div style="flex:1;min-width:200px">
          <label>السورة</label>
          <select id="surahSelect"></select>
        </div>

        <div style="min-width:260px">
          <label>القارئ (اختيار سريع)</label>
          <select id="reciterSelect">
            <!-- قيم افتراضية شائعة — ممكن تكتب identifier يدويًا أدناه -->
            <option value="ar.alafasy">ar.alafasy — مشاري العفاسي</option>
            <option value="ar.abdurrahmaansudais">ar.abdurrahmaansudais — السديس</option>
            <option value="ar.minshawi">ar.minshawi — المنشاوي</option>
            <option value="ar.abdulbasitmurattal">ar.abdulbasitmurattal — عبدالباسط</option>
            <option value="custom">أدخل معرف قارئ يدويًا</option>
          </select>
        </div>

        <div id="customReciterWrap" style="display:none;min-width:260px">
          <label>معرّف القارئ (مثال: ar.alafasy)</label>
          <input id="customReciter" placeholder="ar.alafasy" />
        </div>

        <div style="min-width:150px">
          <label>الجودة</label>
          <select id="bitrate">
            <option value="128">128 kbps</option>
            <option value="64">64 kbps</option>
            <option value="192">192 kbps</option>
          </select>
        </div>

        <div style="min-width:160px">
          <label>&nbsp;</label>
          <div style="display:flex;gap:8px">
            <button id="loadPlay" class="primary">تحميل وتشغيل</button>
            <button id="stopBtn">إيقاف</button>
          </div>
        </div>
      </div>

      <div class="player">
        <div style="display:flex;gap:8px;align-items:center">
          <button id="prev" class="bigbtn">⏮️ تقدّم -10s</button>
          <button id="play" class="bigbtn primary">▶ تشغيل</button>
          <button id="pause" class="bigbtn">⏸ إيقاف مؤقت</button>
          <button id="next" class="bigbtn">⏭️ تأخير +10s</button>
        </div>

        <div style="flex:1">
          <div class="progress" id="progress">
            <div class="bar" id="bar"></div>
          </div>
          <div style="display:flex;justify-content:space-between;margin-top:6px">
            <div class="time" id="current">00:00</div>
            <div class="time" id="duration">00:00</div>
          </div>
        </div>

        <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
          <label class="small">الصوت</label>
          <input id="volume" type="range" min="0" max="1" step="0.01" value="1" />
          <label class="small">السرعة</label>
          <select id="speed">
            <option value="0.75">0.75x</option>
            <option value="1" selected>1x</option>
            <option value="1.25">1.25x</option>
            <option value="1.5">1.5x</option>
          </select>
          <div style="display:flex;gap:6px">
            <button id="download">تحميل</button>
            <button id="open">فتح في نافذة</button>
          </div>
        </div>
      </div>
    </section>

    <section class="card small">
      <strong>ملاحظات:</strong>
      <ul>
        <li>الرابط الذي يُنشئه الموقع يعتمد على النمط: <code>https://cdn.islamic.network/quran/audio-surah/{bitrate}/{edition}/{surah}.mp3</code>. مثال: <code>https://cdn.islamic.network/quran/audio-surah/128/ar.alafasy/1.mp3</code>.</li>
        <li>لو أردت ملفات آية بآية (verse-by-verse) يمكن استخدام: <code>https://cdn.islamic.network/quran/audio/{bitrate}/{edition}/{ayahNumber}.mp3</code> (حيث {ayahNumber} رقم الآية من 1 إلى 6236).</li>
        <li>بديل آخر (ملفات جاهزة مجلدية): everyayah.com — مجلدات لكل قارئ مع ملفات mp3.</li>
      </ul>
    </section>

    <footer class="small">لو ظهر خطأ (404 أو CORS) أبلغني بالرسالة وسأحلّه — غالباً رفع الصفحة على Netlify/Vercel أو تشغيل من سيرفر محلي يحل أي قيود CORS.</footer>
  </div>

<script>
  // Player logic (CDN-based)
  const surahSelect = document.getElementById('surahSelect');
  const reciterSelect = document.getElementById('reciterSelect');
  const customWrap = document.getElementById('customReciterWrap');
  const customReciter = document.getElementById('customReciter');
  const bitrate = document.getElementById('bitrate');
  const loadPlay = document.getElementById('loadPlay');
  const stopBtn = document.getElementById('stopBtn');
  const playBtn = document.getElementById('play');
  const pauseBtn = document.getElementById('pause');
  const prevBtn = document.getElementById('prev');
  const nextBtn = document.getElementById('next');
  const bar = document.getElementById('bar');
  const progress = document.getElementById('progress');
  const current = document.getElementById('current');
  const duration = document.getElementById('duration');
  const vol = document.getElementById('volume');
  const speed = document.getElementById('speed');
  const download = document.getElementById('download');
  const openBtn = document.getElementById('open');

  // populate 1..114 (try fetch names, else numbers)
  (async function initSurah(){
    try {
      const r = await fetch('https://api.alquran.cloud/v1/surah');
      const j = await r.json();
      if(j.data && j.data.length){
        j.data.forEach(s=>{
          const opt = document.createElement('option');
          opt.value = s.number;
          opt.textContent = `${s.number} — ${s.englishName || s.name}`;
          surahSelect.appendChild(opt);
        });
        surahSelect.value = 1;
        return;
      }
    } catch(e){
      // ignore
    }
    for(let i=1;i<=114;i++){
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = `سورة رقم ${i}`;
      surahSelect.appendChild(opt);
    }
  })();

  // show custom input if chosen
  reciterSelect.addEventListener('change', ()=>{
    if(reciterSelect.value === 'custom'){ customWrap.style.display='block'; } else customWrap.style.display='none';
  });

  function getReciterIdentifier(){
    return reciterSelect.value === 'custom' ? (customReciter.value.trim() || 'ar.alafasy') : reciterSelect.value;
  }

  function buildSurahUrl(reciterId, surahNum, br){
    // surah mp3 (single file)
    return `https://cdn.islamic.network/quran/audio-surah/${br}/${encodeURIComponent(reciterId)}/${surahNum}.mp3`;
  }

  let audio = new Audio();
  audio.crossOrigin = "anonymous"; // try to avoid CORS issues
  audio.preload = 'auto';
  audio.volume = parseFloat(vol.value);
  audio.playbackRate = parseFloat(speed.value);
  let currentUrl = '';

  loadPlay.addEventListener('click', ()=> {
    const reciter = getReciterIdentifier();
    const s = surahSelect.value;
    const br = bitrate.value;
    const url = buildSurahUrl(reciter, s, br);
    currentUrl = url;
    audio.src = url;
    audio.load();
    audio.play().catch(err=> {
      alert('تعذّر تشغيل الملف تلقائياً. افتح الكونسول أو جرّب رفع الصفحة على استضافة (Netlify/Vercel).');
      console.warn(err);
    });
  });

  playBtn.onclick = ()=> audio.play();
  pauseBtn.onclick = ()=> audio.pause();
  stopBtn.onclick = ()=> { audio.pause(); audio.currentTime = 0; updateProgress(); }

  prevBtn.onclick = ()=> { audio.currentTime = Math.max(0, audio.currentTime - 10); updateProgress(); }
  nextBtn.onclick = ()=> { audio.currentTime = Math.min(audio.duration || 0, audio.currentTime + 10); updateProgress(); }

  audio.ontimeupdate = updateProgress;
  audio.onloadedmetadata = updateProgress;
  function updateProgress(){
    if(!audio.duration || isNaN(audio.duration)){ duration.textContent = '00:00'; current.textContent='00:00'; bar.style.width='0%'; return; }
    const pct = (audio.currentTime / audio.duration) * 100;
    bar.style.width = pct + '%';
    const fmt = t => { if(!t||isNaN(t)) return '00:00'; const m=Math.floor(t/60); const s=Math.floor(t%60); return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; };
    current.textContent = fmt(audio.currentTime);
    duration.textContent = fmt(audio.duration);
  }

  progress.addEventListener('click', (e)=>{
    const rect = progress.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const pct = x / rect.width;
    if(audio.duration) audio.currentTime = pct * audio.duration;
  });

  vol.addEventListener('input', ()=> audio.volume = parseFloat(vol.value));
  speed.addEventListener('change', ()=> audio.playbackRate = parseFloat(speed.value));

  download.addEventListener('click', ()=>{
    if(!currentUrl) return alert('حمّل سورة أولاً ثم اضغط تحميل');
    const a = document.createElement('a'); a.href = currentUrl; a.download = `surah_${surahSelect.value}.mp3`; document.body.appendChild(a); a.click(); a.remove();
  });
  openBtn.addEventListener('click', ()=> {
    if(!currentUrl) return alert('افتح سورة أولاً');
    window.open(currentUrl,'_blank');
  });

  // helpful: test a known example URL for quick debug (uncomment to test)
  // audio.src = 'https://cdn.islamic.network/quran/audio-surah/128/ar.alafasy/1.mp3';

</script>
</body>
</html>
